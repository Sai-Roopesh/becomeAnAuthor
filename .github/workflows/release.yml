name: Release App

on:
  push:
    tags:
      - "v*.*.*"
      - "*.*.*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing git tag to release (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  validate-release-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Resolve tag
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "push" ]]; then
            TAG="${GITHUB_REF_NAME}"
          else
            TAG="${{ inputs.tag }}"
          fi

          if [[ ! "$TAG" =~ ^v?[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Tag must match <major>.<minor>.<patch> or v<major>.<minor>.<patch>. Got: $TAG"
            exit 1
          fi

          git fetch --tags --force
          git rev-parse "refs/tags/$TAG" >/dev/null 2>&1 || {
            echo "Tag $TAG does not exist in repository. Create and push the tag first."
            exit 1
          }

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Verify version files match tag
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ steps.resolve.outputs.tag }}"
          VERSION="${TAG#v}"

          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          TAURI_VERSION=$(node -p "require('./backend/tauri.conf.json').version")
          CARGO_VERSION=$(grep -m1 '^version\s*=\s*"' backend/Cargo.toml | sed -E 's/version\s*=\s*"([^"]+)"/\1/')

          echo "Tag: $TAG"
          echo "package.json: $PACKAGE_VERSION"
          echo "backend/tauri.conf.json: $TAURI_VERSION"
          echo "backend/Cargo.toml: $CARGO_VERSION"

          if [[ "$PACKAGE_VERSION" != "$VERSION" ]] || [[ "$TAURI_VERSION" != "$VERSION" ]] || [[ "$CARGO_VERSION" != "$VERSION" ]]; then
            echo "Version mismatch. Ensure tag and all version files match before release."
            exit 1
          fi

  build-release:
    needs: validate-release-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: refs/tags/${{ needs.validate-release-tag.outputs.tag }}

      - uses: pnpm/action-setup@v4
        with:
          version: 10.29.2

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install Linux dependencies
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libjavascriptcoregtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Install Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate updater signing secrets
        shell: bash
        run: |
          set -euo pipefail
          [[ -n "${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}" ]] || { echo "Missing TAURI_SIGNING_PRIVATE_KEY secret"; exit 1; }
          [[ -n "${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}" ]] || { echo "Missing TAURI_SIGNING_PRIVATE_KEY_PASSWORD secret"; exit 1; }
          [[ -n "${{ vars.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}" ]] || { echo "Missing NEXT_PUBLIC_GOOGLE_CLIENT_ID repository variable"; exit 1; }
          [[ "${{ vars.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}" == *.apps.googleusercontent.com ]] || { echo "NEXT_PUBLIC_GOOGLE_CLIENT_ID appears invalid"; exit 1; }

      - name: Build and publish release assets
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          NEXT_PUBLIC_GOOGLE_CLIENT_ID: ${{ vars.NEXT_PUBLIC_GOOGLE_CLIENT_ID }}
          APPLE_SIGNING_IDENTITY: "-"
        with:
          tagName: ${{ needs.validate-release-tag.outputs.tag }}
          releaseName: Release ${{ needs.validate-release-tag.outputs.tag }}
          releaseBody: See the assets to download and install this version.
          releaseDraft: false
          prerelease: false
